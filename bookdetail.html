<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Book Detail</title>

<style>
body {
  font-family: Arial;
  padding: 40px;
}

/* ===== Top Section ===== */
.top-section {
  display: flex;
  gap: 40px;
  align-items: flex-start;
  margin-bottom: 40px;
}

.book-image {
  width: 30%;
}

.book-image img {
  width: 100%;
  height: auto;
  object-fit: contain;
  border-radius: 8px;
}

.book-info {
  width: 70%;
}

.book-info h1 {
  margin-top: 0;
}

.info-row {
  margin-bottom: 8px;
}

/* ===== Details Table ===== */
.details-table {
  width: 100%;
  border-collapse: collapse;
}

.details-table th,
.details-table td {
  border: 1px solid #ddd;
  padding: 10px;
  vertical-align: top;
}

.details-table th {
  background: #f5f5f5;
  width: 20%;
  text-align: left;
}

.details-table tr:nth-child(even) {
  background: #fafafa;
}

.details-table {
  width: 100%;
  border-collapse: collapse;
}

.details-table th,
.details-table td {
  border: 1px solid #ccc;
  padding: 8px;
}

.details-table thead {
  background: #f2f2f2;
  font-weight: bold;
}

.details-table tr:nth-child(even) {
  background: #fafafa;
}
  
</style>
</head>
<body>

<div id="content">Loading...</div>

<script>

// 1️⃣ Get ISBN from URL
const params = new URLSearchParams(window.location.search);
const isbn = params.get("isbn");

// 2️⃣ Sheet URLs
const MANGALIST_SHEET = "https://opensheet.elk.sh/1Ker7vSVvehFJw_D7271lONLKs3b0UGj7OIF2aHK3kG8/MangaList";
const STORYMAP_SHEET = "https://opensheet.elk.sh/1Ker7vSVvehFJw_D7271lONLKs3b0UGj7OIF2aHK3kG8/StoriesMangaMapping";
const STORY_SHEET = "https://opensheet.elk.sh/1Ker7vSVvehFJw_D7271lONLKs3b0UGj7OIF2aHK3kG8/Stories";

// 3️⃣ Load everything
Promise.all([
  fetch(MANGALIST_SHEET).then(r => r.json()),
  fetch(STORYMAP_SHEET).then(r => r.json()),
  fetch(STORY_SHEET).then(r => r.json())
])
.then(([mangas, storymaps, stories]) => {

  // 4️⃣ Find manga
  const manga = mangas.find(b => b.ISBN?.trim() === isbn?.trim());

  if (!manga) {
    document.getElementById("content").innerHTML = "Manga not found.";
    return;
  }

  // 5️⃣ Get join rows for this ISBN
  const mangamaps = storymaps
    .filter(j => j.ISBN?.trim() === isbn?.trim())
    .sort((a,b) => Number(a.SeqNum) - Number(b.SeqNum));

  // 6️⃣ Map join rows to actual story rows
  const storyRows = mangamaps.map(j =>
    stories.find(d => d.StoryId?.trim() === j.StoryId?.trim())
  ).filter(Boolean);

  render(manga, storyRows);

})
.catch(err => {
  document.getElementById("content").innerHTML = "Failed to load data.";
  console.error(err);
});


// 7️⃣ Render page
function render(manga, storyRows) {

  // Build table rows from Stories Map sheet
  const tableRows = storyRows.map(d => `
    <tr>
      <td>${d.日本原名 || ""}</td>
      <td>${d.初刊 || ""}</td>
      <td>${d.香港譯名 || ""}</td>
    </tr>
  `).join("");

  const tableHTML = `
  <table class="details-table">
    <thead>
      <tr>
        <th>日本原名</th>
        <th>初刊</th>
        <th>香港譯名</th>
      </tr>
    </thead>
    <tbody>
      ${tableRows}
    </tbody>
  </table>
`;
  
  document.getElementById("content").innerHTML = `

  <!-- ===== Top Section ===== -->
    <div class="top-section">

      <div class="book-image">
        <img src="${manga.Image || ""}" alt="${manga.Title} ${manga.Volume}">
      </div>

      <div class="book-info">
     
        <h1>${manga.Title || ""} ${manga.Volume || ""}</h1>
        <h2>${manga.Subtitle || ""}</h2>
        <div class="detail-row"><strong>日文書名: </strong>${manga.OriginalTitle || ""} ${manga.Volume || ""}  ${manga.OriginalSubtitle || ""}</div>  
        <div class="detail-row"><strong>作者: </strong>${manga.Author || ""}</div>
        <div class="detail-row"><strong>出版社: </strong> ${manga.Publisher || ""}</div>
        <div class="detail-row"><strong>尺碼: </strong> ${manga.Size || ""}</div>
        <div class="detail-row date"><strong>出版日期: </strong> ${manga.IssueDate || ""}</div>
        <div class="detail-row price"><strong>售價: </strong> $${manga.Price || ""}</div>
        <div class="detail-row"><strong>頁數: </strong> ${manga.Page || ""}</div>
        <div class="detail-row"><strong>出版地區: </strong> ${manga.OriginCountry || ""}</div>      
        <div class="detail-row"><strong>ISBN:</strong> ${manga.ISBN || ""}</div>
      </div>
    
    <!-- ===== Bottom Details Table ===== -->
    <table class="details-table">
      <tbody>
        ${tableRows}
      </tbody>
    </table>

    </div>
  `;
}

</script>
</body>
</html>
