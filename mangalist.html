<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Manga List</title>

<style>
body {
  font-family: Arial;
  padding: 30px;
  background: #f5f5f5;
}

.controls {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.controls input,
.controls select {
  padding: 8px 10px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

@media (max-width: 768px) {

  .controls {
    flex-direction: column;
    align-items: stretch;
  }

  .controls input,
  .controls select {
    width: 100%;
    font-size: 16px;   /* better for touch */
  }

}
  
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 15px;
}

.card {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.card img {
  width: 100%;
  height: auto;
  border-radius: 6px;
}

.price {
  color: green;
  font-weight: bold;
  margin-top: 5px;
}

.detail-container {
  display: flex;
  gap: 20px;
  align-items: stretch;  /* important */
}

.detail-left {
  width: 35%;
}

.detail-left img {
  width: 100%;
  height: 100%;
  object-fit: contain;   /* show full image */
  display: block;
}

.detail-right {
  width: 65%;
}

.detail-row {
  margin-bottom: 8px;
}

.detail-description {
  margin-top: 15px;
}

.detail-description p {
  margin-top: 5px;
  line-height: 1.6;
}

.modal-content {
  display: flex;
  flex-direction: column;
}

.modal-box {
  background: white;
  width: 90%;
  max-width: 900px;
  margin: 5% auto;
  padding: 20px;
  border-radius: 8px;
  position: relative;
  display: flex;
}

#pagination button {
  margin: 0 4px;
  padding: 6px 10px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
  border-radius: 4px;
}

#pagination button:hover:not(:disabled) {
  background: #f0f0f0;
}

#pagination button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.active-page {
  background: #333 !important;
  color: white;
  font-weight: bold;
}

#pagination {
  margin-top: 20px;
  text-align: center;
}

#pagination button {
  margin: 0 4px;
  padding: 6px 10px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
  border-radius: 4px;
}

#pagination button:hover:not(:disabled) {
  background: #f0f0f0;
}

#pagination button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.active-page {
  background: #333 !important;
  color: white;
  font-weight: bold;
}

.ellipsis {
  margin: 0 6px;
  color: #888;
}

#detailContent {
  width: 100%;
}
</style>
</head>

<body>

<h1>My Manga</h1>

<div class="controls">
  <input type="text" id="searchInput" placeholder="任何文字搜尋..." oninput="applyFilters()">

  <select id="titleFilter" onchange="applyFilters()">
    <option value="">所有書名</option>
  </select>
  <select id="publisherFilter" onchange="applyFilters()">
    <option value="">所有出版社</option>
  </select>
  <select id="authorFilter" onchange="applyFilters()">
    <option value="">所有作者</option>
  </select>
  <select id="originCountryFilter" onchange="applyFilters()">
    <option value="">所有出版地區</option>
  </select>
  <select id="sortIssueDate" onchange="applyFilters()">
    <option value="">按出版日期</option>
    <option value="newest">從新到舊</option>
    <option value="oldest">從舊到新</option>
  </select>
  <select id="sortPrice" onchange="applyFilters()">
    <option value="">按售價</option>
    <option value="low">從低到高排序</option>
    <option value="high">從高到低排序</option>
  </select> 
</div>
<div id="pagination" style="margin-top:20px; text-align:center;"></div>
<div class="grid" id="mangalist">Loading...</div>

<script>
const SHEET_URL = "https://opensheet.elk.sh/1Ker7vSVvehFJw_D7271lONLKs3b0UGj7OIF2aHK3kG8/MangaList";
let sheetData = [];
let currentPage = 1;
const itemsPerPage = 12;   // change this to 8, 16, etc.
let currentList = [];      // you already use this for modal nav

fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {

    // Only keep Active = Yes
    sheetData = data.filter(row =>
      row.Active?.toLowerCase() === "yes"
    );

    populatePublishers();
    populateTitles();
    populateAuthors();
    populateOriginCountries();
    applyFilters();
  })
  .catch(error => {
    document.getElementById("mangalist").innerHTML = "Failed to load data.";
    console.error(error);
  });

function populatePublishers() {
  const publisherSelect = document.getElementById("publisherFilter");

  const publishers = [...new Set(sheetData.map(row => row.Publisher))];

  publishers.forEach(pub => {
    const option = document.createElement("option");
    option.value = pub;
    option.textContent = pub;
    publisherSelect.appendChild(option);
  });
}

function populateTitles() {
  const titleSelect = document.getElementById("titleFilter");

  const titles = [...new Set(sheetData.map(row => row.Title ))];

  titles.forEach(pub => {
    const option = document.createElement("option");
    option.value = pub;
    option.textContent = pub;
    titleSelect.appendChild(option);
  });
}

function populateAuthors() {
  const authorSelect = document.getElementById("authorFilter");

  const authors = [...new Set(sheetData.map(row => row.Author ))];

  authors.forEach(auth => {
    const option = document.createElement("option");
    option.value = auth;
    option.textContent = auth;
    authorSelect.appendChild(option);
  });
}

function populateOriginCountries() {
  const originCountrySelect = document.getElementById("originCountryFilter");

  const originCountries = [...new Set(sheetData.map(row => row.OriginCountry ))];

  originCountries.forEach(origCountry => {
    const option = document.createElement("option");
    option.value = origCountry;
    option.textContent = origCountry;
    originCountrySelect.appendChild(option);
  });
}

function openDetail(id) {

  currentIndex = currentList.findIndex(d => d.ISBN === id);
  const detail = currentList[currentIndex];

  if (!detail) {
    document.getElementById("detailContent").innerHTML =
      "No detail found.";
  } else {
    document.getElementById("detailContent").innerHTML = `
  <div class="detail-container">

    <div class="detail-left">
      <img src="${detail.Image || ""}" 
      alt="${detail.Title} ${detail.Volume}"      
      onclick="openLightbox('${detail.Image}')"
      style="cursor: zoom-in;">
    </div>

    <div class="detail-right">
      <h1>${detail.Title || ""} ${detail.Volume || ""}</h1>
      <h2>${detail.Subtitle || ""}</h2>
      <div class="detail-row"><strong>日文書名: </strong>${detail.OriginalTitle || ""} ${detail.Volume || ""}  ${detail.OriginalSubtitle || ""}</div>  
      <div class="detail-row"><strong>作者: </strong>${detail.Author || ""}</div>
      <div class="detail-row"><strong>出版社: </strong> ${detail.Publisher || ""}</div>
      <div class="detail-row"><strong>尺碼: </strong> ${detail.Size || ""}</div>
      <div class="detail-row date"><strong>出版日期: </strong> ${detail.IssueDate || ""}</div>
      <div class="detail-row price"><strong>售價: </strong> $${detail.Price || ""}</div>
      <div class="detail-row"><strong>頁數: </strong> ${detail.Page || ""}</div>
      <div class="detail-row"><strong>出版地區: </strong> ${detail.OriginCountry || ""}</div>      
      <div class="detail-row"><strong>ISBN:</strong> ${detail.ISBN || ""}</div>
    </div>

  </div>
  <button onclick="prevItem()" style="position:absolute; left:10px; top:50%;">◀</button>
  <button onclick="nextItem()" style="position:absolute; right:10px; top:50%;">▶</button>
    `;
  }

  document.getElementById("detailModal").style.display = "block";
}

function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

function openLightbox(src) {
  document.getElementById("lightboxImg").src = src;
  document.getElementById("imageLightbox").style.display = "flex";
}

function closeLightbox() {
  document.getElementById("imageLightbox").style.display = "none";
}

function nextItem() {
  if (currentIndex < currentList.length - 1) {
    currentIndex++;
    openDetail(currentList[currentIndex].ISBN);
  }
}

function prevItem() {
  if (currentIndex > 0) {
    currentIndex--;
    openDetail(currentList[currentIndex].ISBN);
  }
}
  
function applyFilters() {

  const search = document.getElementById("searchInput").value.toLowerCase();
  const publisher = document.getElementById("publisherFilter").value;
  const title = document.getElementById("titleFilter").value;
  const author = document.getElementById("authorFilter").value;
  const originCountry = document.getElementById("originCountryFilter").value;
  const sortPrice = document.getElementById("sortPrice").value; 
  const sortIssueDate = document.getElementById("sortIssueDate").value;
  
  let filtered = sheetData.filter(row => {

//    const searchMatch =
//      row.Title?.toLowerCase().includes(search);
    const searchMatch = Object.values(row)
      .join(" ")
      .toLowerCase()
      .includes(search);

    const publisherMatch =
      publisher === "" || row.Publisher === publisher;

    const titleMatch =
      title === "" || row.Title === title;

    const authorMatch =
      author === "" || row.Author === author;

    const originCountryMatch =
      originCountry === "" || row.OriginCountry === originCountry;
    
    return searchMatch && publisherMatch && titleMatch && authorMatch && originCountryMatch;
  });

  // Sort price
  if (sortPrice === "low") {
    filtered.sort((a,b) => Number(a.Price) - Number(b.Price));
  }

  if (sortPrice === "high") {
    filtered.sort((a,b) => Number(b.Price) - Number(a.Price));
  }

  // Sort Issue Date
  if (sortIssueDate === "newest") {
    filtered.sort((a, b) => new Date(b.IssueDate) - new Date(a.IssueDate) );
  }

  if (sortIssueDate === "oldest") {
    filtered.sort((a, b) => new Date(a.IssueDate) - new Date(b.IssueDate)  );
  }
<!--  
  const html = filtered.map(row => `
    <div class="card" onclick="openDetail('${row.ISBN}')">
      <img src="${row.Image}" alt="${row.Title}">
      <h3>書名: ${row.Title} ${row.Volume}</h3>
      <h4>${row.Subtitle}</h4>
      <div>作者: ${row.Author}</div>
      <div>出版社: ${row.Publisher}</div>
      <div class="date">出版日期: ${row.IssueDate}</div>
-->
    </div>
  `).join("");

//  document.getElementById("mangalist").innerHTML =
//    filtered.length ? html : "No Manga found.";
  currentList = filtered;
  currentPage = 1; // reset to first page when filtering
  renderPage();
}

function renderPage() {

  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = currentList.slice(start, end);

  const html = pageItems.map(row => `
<!--    <div class="card" onclick="openDetail('${row.ISBN}')"> -->
    <div class="card" onclick="location.href='bookdetail.html?isbn=${row.ISBN}'">
      <img src="${row.Image}" alt="${row.Title}">
      <h3>書名: ${row.Title} ${row.Volume}</h3>
      <h4>${row.Subtitle}</h4>
      <div>作者: ${row.Author}</div>
      <div>出版社: ${row.Publisher}</div>
      <div class="date">出版日期: ${row.IssueDate}</div>
    </div>
  `).join("");

  document.getElementById("mangalist").innerHTML =
    pageItems.length ? html : "No Manga found.";

  renderPaginationControls();
}

function renderPaginationControls() {

  const totalPages = Math.ceil(currentList.length / itemsPerPage);

  if (totalPages <= 1) {
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  let html = "";

  // ----- Page Info -----
  html += `<div style="margin-bottom:10px;">
             Page ${currentPage} of ${totalPages}
           </div>`;

  // ----- First -----
  html += `
    <button onclick="changePage(1)" ${currentPage === 1 ? "disabled" : ""}>
      &laquo; First
    </button>
  `;

  // ----- Prev -----
  html += `
    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>
      &lsaquo; Prev
    </button>
  `;

  // ----- Page Numbers Logic -----

  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // Adjust window if near edges
  if (currentPage <= 3) {
    endPage = Math.min(totalPages, maxVisible);
  }

  if (currentPage >= totalPages - 2) {
    startPage = Math.max(1, totalPages - (maxVisible - 1));
  }

  // Always show page 1
  if (startPage > 1) {
    html += `<button onclick="changePage(1)">1</button>`;
    if (startPage > 2) {
      html += `<span class="ellipsis">...</span>`;
    }
  }

  // Middle Pages
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <button onclick="changePage(${i})"
        ${i === currentPage ? "class='active-page'" : ""}>
        ${i}
      </button>
    `;
  }

  // Always show last page
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<span class="ellipsis">...</span>`;
    }
    html += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
  }

  // ----- Next -----
  html += `
    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>
      Next &rsaquo;
    </button>
  `;

  // ----- Last -----
  html += `
    <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? "disabled" : ""}>
      Last &raquo;
    </button>
  `;

  document.getElementById("pagination").innerHTML = html;
}

function changePage(page) {

  const totalPages = Math.ceil(currentList.length / itemsPerPage);

  if (page < 1 || page > totalPages) return;

  currentPage = page;
  renderPage();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

  
  document.addEventListener("contextmenu", function(e) {
    if (e.target.tagName === "IMG") {
      e.preventDefault();
    }
  });
  document.addEventListener("keydown", function(e) {
    if (e.key === "F12") {
      e.preventDefault();
    }
  });
</script>
<div id="detailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);">
  <div class="modal-box">
    <button onclick="closeModal()" style="position:absolute; right:10px; top:10px;">X</button>
    <div id="detailContent"></div>
  </div>
</div>

<div id="imageLightbox" onclick="closeLightbox()" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  justify-content:center;
  align-items:center;
  z-index:2000;
">
  <img id="lightboxImg" style="
    max-width:90%;
    max-height:90%;
    object-fit:contain;
    cursor:zoom-out;
  ">
</div>
</body>
</html>
